name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      release:
        description: 'Create a release after successful build'
        type: boolean
        default: false
      dry_run:
        description: 'Dry run release (validate only)'
        type: boolean
        default: false

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

env:
  NODE_VERSION: '22'
  WORKING_DIR: './dsl/domain-lang'

jobs:
  # ============================================================================
  # Build & Test
  # ============================================================================
  build:
    name: Build & Test
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      version: ${{ steps.version.outputs.version }}
      commit_sha: ${{ steps.commit.outputs.sha }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config --global init.defaultBranch main
          git config --global advice.defaultBranchName false

      - name: Get commit SHA
        id: commit
        run: echo "sha=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT

      - name: Setup Node and install dependencies
        uses: ./.github/actions/setup-node-npm
        with:
          node-version: ${{ env.NODE_VERSION }}
          working-directory: ${{ env.WORKING_DIR }}
          cache-dependency-path: '**/package-lock.json'

      - name: Generate Langium
        run: npm run langium:generate
        working-directory: ${{ env.WORKING_DIR }}

      - name: Build
        run: npm run build
        working-directory: ${{ env.WORKING_DIR }}

      - name: Lint
        run: npm run lint
        working-directory: ${{ env.WORKING_DIR }}

      - name: Test
        run: npm test
        working-directory: ${{ env.WORKING_DIR }}

      - name: Test Coverage
        run: npm run test:coverage --workspace packages/language
        working-directory: ${{ env.WORKING_DIR }}

      - name: Upload coverage (lcov)
        uses: actions/upload-artifact@v4
        with:
          name: coverage-lcov
          path: ${{ env.WORKING_DIR }}/packages/language/coverage/lcov.info
          retention-days: 14
          if-no-files-found: error

      - name: Compute Version
        id: version
        run: |
          CURRENT_VERSION=$(node -p "require('./dsl/domain-lang/package.json').version")
          MAJOR=$(echo $CURRENT_VERSION | cut -d. -f1)
          MINOR=$(echo $CURRENT_VERSION | cut -d. -f2)
          NEW_VERSION="${MAJOR}.${MINOR}.${{ github.run_number }}"
          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "Computed version: $NEW_VERSION"

      - name: Version Packages
        run: |
          VERS=${{ steps.version.outputs.version }}
          npm pkg set version=$VERS --workspace=packages/extension
          npm pkg set version=$VERS --workspace=packages/language
          npm pkg set version=$VERS --workspace=packages/cli
          npm pkg set "dependencies.@domainlang/language=$VERS" --workspace=packages/extension
          npm pkg set "dependencies.@domainlang/language=$VERS" --workspace=packages/cli
        working-directory: ${{ env.WORKING_DIR }}

      - name: Build VSIX
        run: |
          mkdir -p ./dist
          cp ../../LICENSE packages/extension/LICENSE
          cd packages/extension
          npx @vscode/vsce package --allow-missing-repository --no-update-package-json --no-dependencies
          mv vscode-domainlang-*.vsix ../../dist/vscode-domainlang-${{ steps.version.outputs.version }}.vsix
        working-directory: ${{ env.WORKING_DIR }}

      - name: Build NPM Packages
        run: |
          mkdir -p dist/npm
          cd packages/language && npm pack --pack-destination ../../dist/npm && cd ../..
          cd packages/cli && npm pack --pack-destination ../../dist/npm && cd ../..
        working-directory: ${{ env.WORKING_DIR }}

      - name: Prepare Artifacts
        run: |
          cp -r ./dsl/domain-lang/packages/demo/dist ./dsl/domain-lang/dist/demo 2>/dev/null || true
          cat > ./dsl/domain-lang/dist/manifest.yaml << EOF
          version: ${{ steps.version.outputs.version }}
          commit_sha: ${{ steps.commit.outputs.sha }}
          build_date: $(date -u +"%Y-%m-%dT%H:%M:%SZ")
          EOF

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: ./dsl/domain-lang/dist
          retention-days: 90
          if-no-files-found: error

      - name: Build Summary
        run: |
          echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Version | \`${{ steps.version.outputs.version }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Commit | \`${{ steps.commit.outputs.sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Run ID | \`${{ github.run_id }}\` |" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # Security Analysis (CodeQL)
  # ============================================================================
  codeql:
    name: CodeQL Analysis
    runs-on: ubuntu-latest
    needs: build
    permissions:
      security-events: write
      actions: read
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: javascript-typescript
          queries: security-and-quality

      - name: Setup Node and install dependencies
        uses: ./.github/actions/setup-node-npm
        with:
          node-version: ${{ env.NODE_VERSION }}
          working-directory: ${{ env.WORKING_DIR }}
          cache-dependency-path: '**/package-lock.json'

      - name: Build for analysis
        run: npm run langium:generate && npm run build
        working-directory: ${{ env.WORKING_DIR }}

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:javascript-typescript"

  # ============================================================================
  # SonarQube
  # ============================================================================
  sonarqube:
    name: SonarQube Analysis
    runs-on: ubuntu-latest
    needs: build
    permissions:
      contents: read
    env:
      SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
      IS_FORK_PR: ${{ github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name != github.repository }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download coverage (lcov)
        uses: actions/download-artifact@v4
        with:
          name: coverage-lcov
          path: ${{ env.WORKING_DIR }}/packages/language/coverage

      - name: SonarQube preflight
        shell: bash
        run: |
          if [[ -z "${SONAR_TOKEN}" || -z "${SONAR_HOST_URL}" ]]; then
            echo "SonarQube is not configured (missing SONAR_TOKEN or SONAR_HOST_URL). Skipping scan."
            exit 0
          fi

          if [[ "${IS_FORK_PR}" == "true" ]]; then
            echo "Skipping SonarQube scan for forked PR (secrets are not available)."
            exit 0
          fi

      - name: SonarQube Scan
        uses: SonarSource/sonarqube-scan-action@v2
        if: env.SONAR_TOKEN != '' && env.SONAR_HOST_URL != '' && env.IS_FORK_PR != 'true'
        env:
          SONAR_TOKEN: ${{ env.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ env.SONAR_HOST_URL }}
        with:
          args: >-
            -Dsonar.projectKey=${{ github.repository_owner }}_${{ github.event.repository.name }}
            -Dsonar.projectName=${{ github.repository }}
            -Dsonar.sources=dsl/domain-lang/packages
            -Dsonar.tests=dsl/domain-lang/packages
            -Dsonar.test.inclusions=**/*.test.ts
            -Dsonar.exclusions=**/node_modules/**,**/out/**,**/dist/**,**/generated/**
            -Dsonar.javascript.lcov.reportPaths=dsl/domain-lang/packages/language/coverage/lcov.info

  # ============================================================================
  # Deploy Documentation (main branch only)
  # ============================================================================
  deploy-docs:
    name: Deploy Documentation
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    permissions:
      contents: read
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    concurrency:
      group: pages-docs
      cancel-in-progress: false

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node and install dependencies
        uses: ./.github/actions/setup-node-npm
        with:
          node-version: '20'
          working-directory: site
          cache-dependency-path: site/package-lock.json

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Build VitePress
        run: npm run build
        working-directory: site

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: site/.vitepress/dist

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  # ============================================================================
  # Release (manual trigger only)
  # ============================================================================
  release:
    name: Release
    runs-on: ubuntu-latest
    needs: [build, codeql, sonarqube]
    if: github.event_name == 'workflow_dispatch' && inputs.release && github.ref == 'refs/heads/main'
    permissions:
      contents: write
      actions: read
      id-token: write
    environment: production

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts
          path: ./artifacts

      - name: Get Version Info
        id: info
        run: |
          cat ./artifacts/manifest.yaml
          VERSION=$(grep '^version:' ./artifacts/manifest.yaml | cut -d' ' -f2)
          SHA=$(grep '^commit_sha:' ./artifacts/manifest.yaml | cut -d' ' -f2)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "sha=$SHA" >> $GITHUB_OUTPUT
          echo "Version: $VERSION, Commit: $SHA"

      - name: Validate Artifacts
        run: |
          VERSION="${{ steps.info.outputs.version }}"
          ls -la ./artifacts/
          ls -la ./artifacts/npm/
          [ -f "./artifacts/vscode-domainlang-${VERSION}.vsix" ] || { echo "VSIX not found"; exit 1; }
          [ -f "./artifacts/npm/domainlang-language-${VERSION}.tgz" ] || { echo "Language package not found"; exit 1; }
          [ -f "./artifacts/npm/domainlang-cli-${VERSION}.tgz" ] || { echo "CLI package not found"; exit 1; }
          echo "All artifacts validated"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'
          scope: '@domainlang'

      - name: Verify npm authentication
        run: |
          npm whoami
          echo "Publishing to @domainlang organization"
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Publish to VS Code Marketplace
        if: ${{ !inputs.dry_run }}
        run: |
          npx @vscode/vsce publish \
            --packagePath "./artifacts/vscode-domainlang-${{ steps.info.outputs.version }}.vsix"
        env:
          VSCE_PAT: ${{ secrets.VSCE_PAT }}

      - name: Publish to NPM
        if: ${{ !inputs.dry_run }}
        run: |
          npm publish "./artifacts/npm/domainlang-language-${{ steps.info.outputs.version }}.tgz" --access public --provenance
          npm publish "./artifacts/npm/domainlang-cli-${{ steps.info.outputs.version }}.tgz" --access public --provenance
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Create Git Tag
        if: ${{ !inputs.dry_run }}
        run: |
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git config user.name "github-actions[bot]"
          git tag -a "v${{ steps.info.outputs.version }}" -m "release ${{ steps.info.outputs.version }}" "${{ steps.info.outputs.sha }}"
          git push origin "v${{ steps.info.outputs.version }}"

      - name: Create GitHub Release
        if: ${{ !inputs.dry_run }}
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.info.outputs.version }}
          name: Release v${{ steps.info.outputs.version }}
          target_commitish: ${{ steps.info.outputs.sha }}
          generate_release_notes: true
          files: |
            ./artifacts/vscode-domainlang-${{ steps.info.outputs.version }}.vsix
            ./artifacts/npm/*.tgz

      - name: Release Summary
        run: |
          echo "## ${{ inputs.dry_run && 'ðŸ§ª Dry Run' || 'ðŸš€ Released' }} v${{ steps.info.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- Commit: ${{ steps.info.outputs.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- [VS Code Marketplace](https://marketplace.visualstudio.com/items?itemName=thinkability.domain-lang)" >> $GITHUB_STEP_SUMMARY
          echo "- [NPM @domainlang/language](https://www.npmjs.com/package/@domainlang/language)" >> $GITHUB_STEP_SUMMARY
          echo "- [NPM @domainlang/cli](https://www.npmjs.com/package/@domainlang/cli)" >> $GITHUB_STEP_SUMMARY
